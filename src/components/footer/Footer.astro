---
import { getCollection } from 'astro:content'

interface Props {
  config?: {
    since?: number
    icon?: {
      name?: string
      color?: string
    }
    count?: boolean
    powered?: boolean
    icp?: {
      enable?: boolean
      icon?: string
      icpnumber?: string
      beian?: string
      recordcode?: string
    }
  }
  siteName?: string
  author?: string
}

const { config = {}, siteName = 'ShokaX', author = 'Author' } = Astro.props

// Get all posts for statistics
const allPosts = await getCollection('posts')
const posts = allPosts.filter((post) => !post.data.draft)

// Calculate statistics
const wordCounts = posts.map((post) => {
  const content = post.body || ''
  // Simple word count: Chinese characters + English words
  const chineseCount = (content.match(/[\u4e00-\u9fff]/g) || []).length
  const englishText = content.replace(/[\u4e00-\u9fff]/g, '')
  const englishCount = englishText
    .trim()
    .split(/\s+/)
    .filter((word) => word.length > 0).length
  return chineseCount + englishCount
})
const totalWords = wordCounts.reduce((a, b) => a + b, 0)

// Calculate reading time (using 300 WPM as baseline for mixed content)
const avgWordsPerMinute = 300
const readingMinutes = Math.ceil(totalWords / avgWordsPerMinute)
const readingTimeStr = readingMinutes === 1 ? '1 minute' : `${readingMinutes} minutes`

// Get current year for copyright
const currentYear = new Date().getFullYear()
const since = config.since || currentYear

const iconName = config.icon?.name || 'sakura rotate'
const iconColor = config.icon?.color || '#ffc0cb'
---

<footer id="footer" class="text-grey-5 text-sm bg-body-bg-shadow mt-12 py-8 border-t border-grey-3">
  <div class="inner mx-auto w-full max-w-3xl px-4">
    <div class="status text-center w-full">
      <!-- Copyright Section -->
      <div class="copyright block my-2">
        {since !== currentYear && <span>&copy; {since} -</span>}
        <span>{currentYear}</span>
        <span class="with-love inline-block mx-0.5 ml-0.5" style={`color: ${iconColor}`}>
          <i class={`${iconName}`}></i>
        </span>
        <span class="author">{author} @ {siteName}</span>
      </div>

      <!-- Statistics Section -->
      {
        config.count && (
          <div class="count block my-2">
            <span class="post-meta-item-icon mr-0 inline">
              <div class="i-ri-line-chart-fill inline-block align-text-bottom text-1rem"></div>
            </span>
            <span title="Total words">{totalWords} words</span>
            <span class="post-meta-divider mx-2"> | </span>
            <span class="post-meta-item-icon mr-0 inline">
              <div class="i-ri-cup-fill inline-block align-text-bottom text-1rem"></div>
            </span>
            <span title="Estimated reading time">{readingTimeStr}</span>
          </div>
        )
      }

      <!-- Powered By Section -->
      {
        config.powered && (
          <div class="powered-by block my-2 text-xs">
            Powered by{' '}
            <a href="https://astro.build" target="_blank" class="hover:opacity-80 border-b border-dashed">
              Astro
            </a>{' '}
            & Theme{' '}
            <a
              href="https://github.com/theme-shoka-x/hexo-theme-shokaX/"
              target="_blank"
              class="hover:opacity-80 border-b border-dashed"
            >
              ShokaX
            </a>
          </div>
        )
      }

      <!-- ICP Section -->
      {
        config.icp?.enable && (
          <div class="icp block text-xs leading-loose mt-4">
            <a
              href="https://beian.miit.gov.cn"
              target="_blank"
              class="text-grey-5 hover:opacity-80 border-b border-dashed"
            >
              {config.icp.icpnumber}
            </a>
            {config.icp.beian && config.icp.recordcode && (
              <>
                <br />
                <a
                  target="_blank"
                  href={`https://beian.mps.gov.cn/#/query/webSearch?code=${config.icp.recordcode}`}
                  class="inline-block text-grey-5 hover:opacity-80 border-b border-dashed"
                >
                  {config.icp.icon && <img src={config.icp.icon} alt="ICP" class="max-w-8 inline align-middle" />}
                  {config.icp.beian}
                </a>
              </>
            )}
          </div>
        )
      }
    </div>
  </div>
</footer>

<style>
  .inner {
    margin: 2rem auto 0.625rem;
    position: relative;
  }

  @media (min-width: 1024px) {
    .inner {
      max-width: 1160px;
    }
  }

  @media (min-width: 1280px) {
    .inner {
      max-width: 1340px;
    }
  }

  .with-love {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }
</style>
